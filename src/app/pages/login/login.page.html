<ion-content [fullscreen]="true">
  <div class="login-container">
    
    @if (isLogin) {
    <ion-card class="auth-card">
      <ion-card-header>
        <ion-card-title class="titulo">Iniciar Sesión</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <form [formGroup]="loginForm" (ngOnSubmit)="login()">
          <ion-item class="form-item">
            <ion-label position="floating">Correo electrónico</ion-label>
            <ion-input type="email" formControlName="email"></ion-input>
          </ion-item>

          @if (loginForm.get('email')?.invalid && loginForm.get('email')?.touched) {
          <div class="error-message">
            @if (loginForm.get('email')?.errors?.['required']) {
            <span>⚠ El correo es requerido</span>
            } @if (loginForm.get('email')?.errors?.['email']) {
            <span>⚠ Ingresa un correo válido</span>
            }
          </div>
          }

          <ion-item class="form-item">
            <ion-label position="floating">Contraseña</ion-label>
            <ion-input
              [type]="showLoginPassword ? 'text' : 'password'"
              formControlName="password"
            >
            </ion-input>
            <ion-icon
              slot="end"
              [name]="showLoginPassword ? 'eye-off-outline' : 'eye-outline'"
              class="password-icon"
              (click)="toggleLoginPasswordVisibility()"
            >
            </ion-icon>
          </ion-item>

          @if (loginForm.get('password')?.invalid && loginForm.get('password')?.touched) {
          <div class="error-message">
            <span>⚠ La contraseña es requerida</span>
          </div>
          }

          <ion-button
          type="submit"
            (click)="login()"
            class="auth-button"
            expand="block"
            [disabled]="loginForm.invalid || isLoggingIn"
          >
            @if (isLoggingIn) {
              <ion-spinner name="crescent" class="button-spinner"></ion-spinner>
            }
            @if (!isLoggingIn) {
              Entrar
            }
          </ion-button>

          <p class="link-text">
            ¿No tienes cuenta?
            <a class="link" (click)="switchToRegister()">Regístrate</a>
          </p>
        </form>
      </ion-card-content>
    </ion-card>
    } 
    
    @if (!isLogin) {
    <ion-card class="auth-card">
      <ion-card-header>
        <ion-card-title class="titulo">Registro</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <form [formGroup]="registerForm">
          
          <ion-item class="form-item">
            <ion-label position="floating">Nombre</ion-label>
            <ion-input formControlName="nombre"></ion-input>
          </ion-item>
          @if (registerForm.get('nombre')?.invalid && registerForm.get('nombre')?.touched) {
            <div class="error-message"><span>⚠ El nombre es requerido</span></div>
          }

          <ion-item class="form-item">
            <ion-label position="floating">Apellidos</ion-label>
            <ion-input formControlName="apellidos"></ion-input>
          </ion-item>
          @if (registerForm.get('apellidos')?.invalid && registerForm.get('apellidos')?.touched) {
            <div class="error-message"><span>⚠ Los apellidos son requeridos</span></div>
          }

          <ion-item class="form-item">
            <ion-label position="floating">Edad</ion-label>
            <ion-input type="number" formControlName="edad"></ion-input>
          </ion-item>
          @if (registerForm.get('edad')?.invalid && registerForm.get('edad')?.touched) {
            <div class="error-message">
              @if (registerForm.get('edad')?.errors?.['required']) {
                <span>⚠ La edad es requerida</span>
              }
              @if (registerForm.get('edad')?.errors?.['min'] || registerForm.get('edad')?.errors?.['max']) {
                <span>⚠ La edad debe estar entre 1 y 120 años</span>
              }
            </div>
          }

          <ion-item class="form-item">
            <ion-label position="stacked" class="fix-label mb-5">Fecha de nacimiento</ion-label>
            <ion-datetime presentation="date" formControlName="fechaNacimiento">
            </ion-datetime>
          </ion-item>
          @if (registerForm.get('fechaNacimiento')?.invalid && registerForm.get('fechaNacimiento')?.touched) {
            <div class="error-message"><span>⚠ La fecha de nacimiento es requerida</span></div>
          }

          <ion-list>
            <ion-list-header class="list-header">Género</ion-list-header>
            <ion-radio-group formControlName="genero">
              <ion-item class="radio-item">
                <ion-label>Hombre</ion-label>
                <ion-radio slot="start" value="hombre"></ion-radio>
              </ion-item>
              <ion-item class="radio-item">
                <ion-label>Mujer</ion-label>
                <ion-radio slot="start" value="mujer"></ion-radio>
              </ion-item>
              <ion-item class="radio-item">
                <ion-label>Prefiero no decirlo</ion-label>
                <ion-radio slot="start" value="prefiero no decirlo"></ion-radio>
              </ion-item>
            </ion-radio-group>
          </ion-list>
          @if (registerForm.get('genero')?.invalid && registerForm.get('genero')?.touched) {
            <div class="error-message"><span>⚠ El género es requerido</span></div>
          }

          <ion-list>
            <ion-list-header class="list-header">Tipo de Perfil</ion-list-header>
            <ion-radio-group formControlName="tipoPerfil">
              <ion-item class="radio-item">
                <ion-label>Doctor</ion-label>
                <ion-radio slot="start" value="doctor"></ion-radio>
              </ion-item>
              <ion-item class="radio-item">
                <ion-label>Paciente</ion-label>
                <ion-radio slot="start" value="paciente"></ion-radio>
              </ion-item>
            </ion-radio-group>
          </ion-list>
          @if (registerForm.get('tipoPerfil')?.invalid && registerForm.get('tipoPerfil')?.touched) {
            <div class="error-message"><span>⚠ El tipo de perfil es requerido</span></div>
          }

          @if (registerForm.get('tipoPerfil')?.value === 'doctor') {
            <ion-item class="form-item">
              <ion-label position="floating">Cédula Profesional</ion-label>
              <ion-input
                formControlName="cedula"
                type="text"
                maxlength="10"
                inputmode="numeric"
              ></ion-input>
            </ion-item>

            @if (registerForm.get('cedula')?.invalid && registerForm.get('cedula')?.touched) {
              <div class="error-message">
                @if (registerForm.get('cedula')?.errors?.['required']) {
                  <span>⚠ La cédula es requerida</span> 
                } 
                @if (registerForm.get('cedula')?.errors?.['pattern']) {
                  <span>⚠ Solo números</span> 
                } 
                @if (registerForm.get('cedula')?.errors?.['minlength']) {
                  <span>⚠ Mínimo 7 dígitos</span> 
                }
              </div>
            }

            <ion-item class="form-item">
              <ion-label position="floating">Especialidad</ion-label>
              <ion-input formControlName="especialidad"></ion-input>
            </ion-item>

            @if (registerForm.get('especialidad')?.invalid && registerForm.get('especialidad')?.touched) {
              <div class="error-message">
                <span>⚠ La especialidad es requerida</span>
              </div>
            }

            <ion-item class="form-item">
              <ion-label position="floating">Subespecialidad</ion-label>
              <ion-input formControlName="subespecialidad"></ion-input>
            </ion-item>
          } 
          
          @if (registerForm.get('tipoPerfil')?.value === 'paciente') {
            <ion-item class="form-item">
              <ion-label position="floating">Peso (kg)</ion-label>
              <ion-input type="number" formControlName="peso"></ion-input>
            </ion-item>

            @if (registerForm.get('peso')?.invalid && registerForm.get('peso')?.touched) {
              <div class="error-message"><span>⚠ El peso es requerido</span></div>
            }

            <ion-item class="form-item">
              <ion-label position="floating">Altura (cm)</ion-label>
              <ion-input type="number" formControlName="altura"></ion-input>
            </ion-item>

            @if (registerForm.get('altura')?.invalid && registerForm.get('altura')?.touched) {
              <div class="error-message"><span>⚠ La altura es requerida</span></div>
            } 
          }

          <ion-item class="form-item">
            <ion-label position="floating">Correo electrónico</ion-label>
            <ion-input type="email" formControlName="email"></ion-input>
          </ion-item>

          @if (registerForm.get('email')?.invalid && registerForm.get('email')?.touched) {
            <div class="error-message">
              @if (registerForm.get('email')?.errors?.['required']) {
                <span>⚠ El correo es requerido</span>
              } 
              @if (registerForm.get('email')?.errors?.['email']) {
                <span>⚠ Ingresa un correo válido</span>
              }
            </div>
          }

          <ion-item class="form-item">
            <ion-label position="floating">Contraseña</ion-label>
            <ion-input
              [type]="showRegisterPassword ? 'text' : 'password'"
              formControlName="password"
            >
            </ion-input>
            <ion-icon
              slot="end"
              [name]="showRegisterPassword ? 'eye-off-outline' : 'eye-outline'"
              class="password-icon"
              (click)="toggleRegisterPasswordVisibility()"
            >
            </ion-icon>
          </ion-item>

          @if (getPasswordError()) {
            <div class="error-message">
              <span>{{ getPasswordError() }}</span>
            </div>
          }

          <ion-item class="form-item">
            <ion-label position="floating">Confirmar Contraseña</ion-label>
            <ion-input
              [type]="showConfirmPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
            >
            </ion-input>
            <ion-icon
              slot="end"
              [name]="showConfirmPassword ? 'eye-off-outline' : 'eye-outline'"
              class="password-icon"
              (click)="toggleConfirmPasswordVisibility()"
            >
            </ion-icon>
          </ion-item>

          @if (registerForm.errors?.['mismatch'] && registerForm.get('confirmPassword')?.touched) {
            <div class="error-message">
              <span>⚠ Las contraseñas no coinciden</span>
            </div>
          }

          <ion-item class="form-item">
            <ion-label position="stacked" class="mb-5">Foto de perfil</ion-label>
            
            <div class="image-upload-container">
              <label class="file-input-label">
                <input
                  class="file-input"
                  type="file"
                  (change)="onFileSelected($event)"
                  accept="image/*"
                  #fileInput
                />
                <div class="upload-button">
                  <ion-icon name="camera-outline"></ion-icon>
                  <span>Seleccionar imagen</span>
                </div>
              </label>

              @if (imagePreview) {
                <div class="image-preview-container">
                  <img 
                    [src]="imagePreview" 
                    alt="Vista previa" 
                    class="preview-image"
                    [class.loading]="isUploading"
                  >
                  @if (isUploading) {
                    <div class="upload-overlay">
                      <ion-spinner name="crescent"></ion-spinner>
                      <p>Subiendo...</p>
                    </div>
                  }
                  @if (uploadedImageUrl && !isUploading) {
                    <div class="upload-success">
                      <ion-icon name="checkmark-circle" color="success"></ion-icon>
                    </div>
                  }
                </div>
              }
            </div>
          </ion-item>

          @if (isRegistering) {
            <div class="global-loading">
              <ion-spinner name="crescent"></ion-spinner>
              <p>Creando cuenta...</p>
            </div>
          }

          <ion-button
            class="auth-button"
            expand="block"
            (click)="register()"
            [disabled]="registerForm.invalid || isUploading || isRegistering"
          >
            @if (isRegistering) {
              <ion-spinner name="crescent" class="button-spinner"></ion-spinner>
            }
            @if (!isRegistering) {
              Crear cuenta
            }
          </ion-button>

          <p class="link-text">
            ¿Ya tienes cuenta?
            <a class="link" (click)="switchToLogin()">Inicia sesión</a>
          </p>
        </form>
      </ion-card-content>
    </ion-card>
    }
  </div>
</ion-content>